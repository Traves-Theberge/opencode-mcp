# OpenCode MCP Server - Cursor Rules

## Project Overview
This is an MCP (Model Context Protocol) server that exposes OpenCode as a tool/subagent for IDEs and AI clients. It allows MCP-compatible clients to delegate coding tasks to OpenCode.

## Tech Stack
- **Language**: TypeScript (strict mode enabled)
- **Runtime**: Node.js 18+
- **Build**: tsc (TypeScript compiler)
- **Testing**: Vitest
- **Validation**: Zod v4
- **Protocol**: MCP (Model Context Protocol)

## Project Structure
```
src/
├── client/           # OpenCode SDK client wrapper
├── server/           # MCP server implementation
│   └── tools/        # Tool handlers organized by category
│       ├── execution.ts   # opencode_run, sessions
│       ├── files.ts       # file read, search, find
│       ├── config.ts      # model/provider config
│       ├── agents.ts      # agent delegation
│       ├── skills.ts      # skill management
│       ├── mcp.ts         # MCP server management
│       └── tool-config.ts # tool listing
├── utils/            # Shared utilities (config, types)
└── index.ts          # Entry point
```

## Coding Standards

### TypeScript
- Use strict type checking (strict mode is enabled)
- Prefer `interface` over `type` for object shapes
- Use Zod v4 for runtime validation and schema definitions
- Avoid `any` - use `unknown` with type guards instead

### Error Handling
- Use `createErrorResponse()` from `./schemas.js` for consistent error formatting
- Include actionable suggestions in error responses
- Preserve caught errors using `{ cause: error }` pattern

### Imports
- Use `.js` extensions for local imports (required for ESM)
- Group imports: external → internal → relative
- Use named exports for utilities, default for main entry points

### Testing
- Tests go in `tests/` directory
- Smoke tests: `tests/smoke/` - basic functionality
- Integration tests: `tests/integration/` - API interactions
- Run tests: `npm run test:smoke` or `npm run test:integration`

## MCP Tool Patterns

### Tool Registration
```typescript
s.tool('tool_name', 'Description', inputSchema, annotations, handler);
```

### Input Schemas (Zod v4)
```typescript
export const INPUT_SCHEMAS = {
  MyToolInputSchema: {
    param: z.string().describe('Parameter description'),
  },
};
```

### Tool Annotations
```typescript
TOOL_ANNOTATIONS.tool_name: {
  readOnlyHint: boolean,
  destructiveHint: boolean,
  idempotentHint: boolean,
  openWorldHint: boolean,
}
```

### Handler Pattern
```typescript
async tool_name(params: { param: string }) {
  try {
    // Implementation
    return {
      content: [{ type: 'text', text: JSON.stringify(result, null, 2) }],
    };
  } catch (error) {
    return createErrorResponse('Operation', error, ERROR_SUGGESTIONS.xxx);
  }
}
```

## Commands
```bash
npm run build       # Compile TypeScript
npm run lint        # Run ESLint
npm run typecheck   # Type check without emit
npm run test:smoke  # Run smoke tests
npm run clean       # Remove dist/
```

## Config Persistence
Config tools use hybrid persistence:
1. API update for immediate runtime effect
2. File write to `opencode.json` for persistence

Config path detection order:
1. `OPENCODE_CONFIG_PATH` env var
2. `{workingDirectory}/.opencode/opencode.json`
3. `~/.config/opencode/opencode.json`

## When Making Changes
1. Update tests if modifying tool behavior
2. Update tool counts in README.md and docs/api/TOOLS.md
3. Update CHANGELOG.md with changes
4. Run `npm run lint && npm run build` before committing
